name: Daily Update

on:
  schedule:
    - cron: '5 2 * * *'  # æ¯å¤©æ—©ä¸ŠåŒ—äº¬æ—¶é—´09:05æ›´æ–°(UTCæ—¶é—´ä¸º1:05)
  workflow_dispatch:
  push:
    branches: [main]
  repository_dispatch:
    types: [service-down-alert]

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Update README with timestamp
        run: |
          # ç”Ÿæˆå½“å‰æ—¶é—´
          UTC_TIME=$(date -u +'%Y-%m-%d %H:%M:%S')
          BJ_TIME=$(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S')
          
          # åœ¨ README æœ«å°¾æ·»åŠ æˆ–æ›´æ–°æ—¶é—´æˆ³
          TIMESTAMP_SECTION="\n## ğŸ•’ æœ€åæ›´æ–°æ—¶é—´\n\n"
          TIMESTAMP_SECTION+="**UTC**: \`$UTC_TIME\`  \n"
          TIMESTAMP_SECTION+="**åŒ—äº¬æ—¶é—´**: \`$BJ_TIME\`  \n\n"
          TIMESTAMP_SECTION+="> âš¡ æ­¤æ—¶é—´æˆ³ç”± GitHub Actions è‡ªåŠ¨æ›´æ–°\n"
          
          # æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰æ—¶é—´æˆ³éƒ¨åˆ†
          if grep -q "## ğŸ•’ æœ€åæ›´æ–°æ—¶é—´" README.md; then
            sed -i '/## ğŸ•’ æœ€åæ›´æ–°æ—¶é—´/,/^## \|^# /{//!d}' README.md
            sed -i '/## ğŸ•’ æœ€åæ›´æ–°æ—¶é—´/d' README.md
          fi
          
          echo -e "$TIMESTAMP_SECTION" >> README.md
          
      - name: Auto commit changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Auto deploy by Github Actions"
          commit_user_name: "github-actions[bot]"
          commit_user_email: "github-actions[bot]@users.noreply.github.com"
          file_pattern: README.md
      - name: Check Trigger Event
        run: |
          echo "Workflow triggered by: ${{ github.event_name }}"
          if [[ "${{ github.event_name }}" == "repository_dispatch" ]]; then
            echo "è§¦å‘äº‹ä»¶ç±»å‹ (Event Type): ${{ github.event.action }}"
            echo "æ”¶åˆ°æ¥è‡ª Uptime Kuma çš„ä¸‹çº¿é€šçŸ¥ï¼Œå¼€å§‹æ‰§è¡Œè‡ªåŠ¨æ¢å¤éƒ¨ç½²æµç¨‹..."
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "å·¥ä½œæµè¢«æ‰‹åŠ¨è§¦å‘ï¼Œå¼€å§‹æ‰§è¡Œéƒ¨ç½²..."
          else
            echo "å·¥ä½œæµç”±è®¡åˆ’ä»»åŠ¡è§¦å‘ï¼Œå¼€å§‹æ‰§è¡Œéƒ¨ç½²..."
          fi
